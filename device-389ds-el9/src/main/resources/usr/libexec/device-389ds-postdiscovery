#!/bin/bash
  
#
# 389 Directory Server Postdiscovery
# ==================================
#
# This script autogenerates any required 389ds databases.

set -e

#
# Silence warnings with runuser.
cd /tmp


#
# Update ldap instances

find /etc/device/services/ldap-server/instance/ -mindepth 1 -maxdepth 1 -type l | \
while read line; do

  if test ! -f "$line/instance.txt"; then
    continue;
  fi
  instance="$(head $line/instance.txt)"

  # make sure autobind is enabled
  logger -t dirsrv-postdiscovery "enabling directory server autobind on instance ${instance}..."
  dsconf "ldapi://%2frun%2fslapd-${instance}.socket" config replace nsslapd-ldapimaptoentries=on nsslapd-ldapiuidnumbertype=uidNumber nsslapd-ldapigidnumbertype=gidNumber nsslapd-ldapientrysearchbase=ou=people,cn=config || echo "Could not enable autobind" > "$line/error"
  if test ! -f "$line/error"; then
    logger -t dirsrv-postdiscovery "enabled directory server autobind on instance ${instance}."
  else
    logger -t dirsrv-postdiscovery "failed to enable directory server autobind for instance ${instance}."
  fi

done


#
# Add/update/remove ldap backends/suffixes

find /etc/device/services/ldap-server/suffix/ -mindepth 1 -maxdepth 1 -type l | \
while read line; do

  target=$(readlink -f "$line")

  if test ! -f "$line/name.txt"; then
    continue;
  fi
  bename="$(head $line/name.txt)"

  if test ! -f "$line/suffix.txt"; then
    continue;
  fi
  suffix="$(head $line/suffix.txt)"

  if [ ! -e "$line/instance.d/instance.txt" ]; then
    continue;
  fi
  instance="$(head $line/instance.d/instance.txt)"

  # add new instances
  if test -f "$line/added"; then

    if test ! -d "/etc/dirsrv/slapd-${instance}"; then
      logger -t dirsrv-postdiscovery "ignoring directory server backend ${bename} with suffix ${suffix}: instance ${instance} does not exist."
      continue
    fi

    # add instance
    logger -t dirsrv-postdiscovery "adding directory server backend ${bename} with suffix ${suffix} to instance ${instance}..."
    dsconf "ldapi://%2frun%2fslapd-${instance}.socket" backend create --suffix "${suffix}" --be-name "${bename}" || echo "Could not create suffix" > "$line/error"
    if test ! -f "$line/error"; then
      logger -t dirsrv-postdiscovery "added directory server backend ${bename} with suffix ${suffix} to instance ${instance}."
    else
      logger -t dirsrv-postdiscovery "failed to add directory server backend ${bename} with suffix ${suffix} to instance ${instance}."
    fi

    rm -f "$line/added"

  # update instances
  elif test -f "$line/updated"; then


    rm -f "$line/updated"

  # remove old instances
  elif test -f "$line/removed"; then

    # remove instance, but only if no error was created making the database
    if test ! -f "$line/error" -a -d "/etc/dirsrv/slapd-${instance}"; then
      logger -t dirsrv-postdiscovery "removing directory server backend ${bename} with suffix ${suffix} to instance ${instance}..."
      expect <<- EOF || echo "Could not remove suffix" > "$line/error"
set timeout -1
spawn dsconf "ldapi://%2frun%2fslapd-${instance}.socket" backend delete "${bename}"
match_max 100000
expect {
  "Type 'Yes I am sure' to continue: " {
    send -- "Yes I am sure"
    expect -exact "Yes I am sure"
    send -- "\r"
    expect eof
  }
  eof {
    exit 1
  }
}
EOF
      if test ! -f "$line/error"; then
        logger -t dirsrv-postdiscovery "removed directory server backend ${bename} with suffix ${suffix} to instance ${instance}."
      else
        logger -t dirsrv-postdiscovery "failed to remove directory server backend ${bename} with suffix ${suffix} to instance ${instance}, forgetting this suffix."
      fi
    fi

    # remove folder
    rm -f "${target}"/*
    rmdir "${target}"
    rm -f "${line}"
  fi

done

#
# Run all scripts

find "$0.d" -type f -executable -exec {} \; || true

